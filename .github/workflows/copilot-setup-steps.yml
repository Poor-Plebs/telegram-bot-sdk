name: "Copilot Setup Steps"

# This workflow configures the development environment for GitHub Copilot coding agent.
# It must contain exactly one job named "copilot-setup-steps" to be recognized by Copilot.
# See: https://docs.github.com/en/copilot/how-tos/use-copilot-agents/coding-agent/customize-the-agent-environment

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: opcache
          ini-values: |
            memory_limit=4G
            opcache.enable=1
            opcache.validate_timestamps=1
          coverage: pcov

      - name: Verify PHP version
        run: php -v

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> "$GITHUB_OUTPUT"

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: composer install --no-interaction --no-progress --optimize-autoloader --prefer-dist

      - name: Display environment info
        run: |
          echo "PHP version: $(php -v | head -n 1)"
          echo "Composer version: $(composer --version)"
          echo ""
          echo "Available commands:"
          echo "  - composer test      (runs Pest tests without coverage)"
          echo "  - composer coverage  (runs Pest tests with coverage, min 80%)"
          echo "  - composer static    (runs PHPStan analysis)"
          echo "  - composer cs        (checks code style)"
          echo "  - composer csf       (fixes code style)"
          echo "  - composer lint      (PHP syntax check)"
          echo "  - composer ci        (runs full CI pipeline)"
          echo "  - composer all       (runs CI with auto-fix)"
